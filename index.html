<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="style/style.css">
		<title>Pollution</title>
	</head>
	<body>
		<h1>Pollution</h1>
		<h2>Bar chart</h2>
		<svg class="barChart"></svg>
		<br>
		<h2>Cities comparison</h2>
		<p></p>

		<script src="vendor/d3/d3.js"></script>
		<script src="vendor/d3/d3-scale-chromatic.v1.min.js"></script>
		<script>
		var requestUrlGrenoble = 'https://api.atmo-aura.fr/communes/38185/indices?api_token=5a6f7194e07ab6051fe96ccf49a30bdf';

		var width = 450,
				barWidth = 40,
				height = 500;
		var y = d3.scaleLinear()
							.range([0,300]);
		var barChart = d3.select(".barChart")
											.attr("width", width)
											.attr("height", height);

		d3.json(requestUrlGrenoble, function(data) {
			console.log("barchart : ",data);

			var yMax = 100;//d3.max(data["indices"]["data"], function(d) {return d.valeur;});
			y.domain([0, yMax]);


			var annotation = barChart.selectAll(".annotation")
					.classed("annotation", true)
					.data(data["indices"]["data"])
					.enter()
					.filter(function(d, i) {return i === 1;})
					.append('text')
					.attr("x", 375)
					// .attr("dx", "2em")
					.attr("y", 340)
					.style("fill",function(d){
						if (d.valeur <= 20) { return "rgb(106,237,117)";}
						else if ( d.valeur <= 50) { return "rgb(75,161,216)";}
						else if ( d.valeur <= 60) { return "rgb(121,146,155)";}
						else { return "rgb(160,8,69)";}
					})
					.text("Aujourd'hui")

					var annotation2 = barChart.selectAll(".annotation")
							.classed("annotation", true)
							.data(data["indices"]["data"])
							.enter()
							.filter(function(d, i) {return i === 1;})
					.append('text')
					.attr("x", 375)
					.attr("dy", "2em")
					.attr("dx", "4em")
					.attr("y", 340)
					.style("fill",function(d){
						if (d.valeur <= 20) { return "rgb(106,237,117)";}
						else if ( d.valeur <= 50) { return "rgb(75,161,216)";}
						else if ( d.valeur <= 60) { return "rgb(121,146,155)";}
						else { return "rgb(160,8,69)";}
					})
					.text("l'indice de qualitÃ© de l'air")

					var annotation3 = barChart.selectAll(".annotation")
							.classed("annotation", true)
							.data(data["indices"]["data"])
							.enter()
							.filter(function(d, i) {return i === 1;})
					.append('text')
					.attr("x", 375)
					.attr("dx", "-1em")
					.attr("dy", "4em")
					.attr("y", 340)
					.style("fill",function(d){
						if (d.valeur <= 20) { return "rgb(106,237,117)";}
						else if ( d.valeur <= 50) { return "rgb(75,161,216)";}
						else if ( d.valeur <= 60) { return "rgb(121,146,155)";}
						else { return "rgb(160,8,69)";}
					})
					.text(function(d) {return "est " + d.qualificatif;})


			var arrow = barChart.selectAll(".arrow")
					.classed("arrow", true)
					.data(data["indices"]["data"])
					.enter()
					.filter(function(d, i) {return i === 1;})
					.append('path')
					.attr('d', "M 320 305 h 40 l -20 20 z")
					.style("fill", function(d) {
						if (d.valeur <= 20) { return "rgb(106,237,117)";}
						else if ( d.valeur <= 50) { return "rgb(75,161,216)";}
						else if ( d.valeur <= 60) { return "rgb(121,146,155)";}
						else { return "rgb(160,8,69)";}
					});

			var bar = barChart.selectAll("g")
									.data(data["indices"]["data"])
									.enter()
									.filter(function(d, i) {return i < 9;})
									.append("g")
									.attr("transform", function(d,i){ return "translate(" + (9 - i) * barWidth + "," + (y(yMax-d.valeur)) + ")";});

			// barChart.append('path')
			// 		.attr('d', "M 320 305 h 40 l -20 20 z")
			// 		.style("fill", "rgba(106,237,117,1)");

			// Red Purple part : value > 60
			bar.append("rect")
				.attr("width", barWidth - 1)
				.attr("height", function(d) {
					if (d.valeur > 60) { return (y(d.valeur - 60));}
				})
				.attr("fill", function(d,i) {
					if (i === 1) { return "rgba(160,8,69,1)";}
					else { return "rgba(160,8,69,0.5)";}
				});

			// Purple part : 50 < value < 60
			bar.append("rect")
				.attr("width", barWidth - 1)
				.attr("height", function(d) {
					if (d.valeur > 60) { return y(10);}
					else if (d.valeur > 50){ return (y(d.valeur - 50));}
				})
				.attr("transform", function(d){
					if (d.valeur > 60) { return "translate(0," + y(d.valeur - 60) + ")";}
					else { return "translate(0,0)";}
				})
				.attr("fill", function(d,i) {
					if (i === 1) { return "rgba(121,146,155,1)";}
					else { return "rgba(75,161,216,0.5)";}
				});

			// Blue part : 20 < value < 50
			bar.append("rect")
				.attr("width", barWidth - 1)
				.attr("height", function(d) {
					if (d.valeur > 50) { return y(30);}
					else if (d.valeur > 20){ return (y(d.valeur - 20));}
				})
				.attr("transform", function(d){
					if (d.valeur > 50) { return "translate(0," + y(d.valeur - 50) + ")";}
					else { return "translate(0,0)";}
				})
				.attr("fill", function(d,i) {
					if (i === 1) { return "rgba(75,161,216,1)";}
					else { return "rgba(75,161,216,0.5)";}
				});

			// Green part : value < 20
			bar.append("rect")
				.attr("width", barWidth - 1)
				.attr("height", function(d) {
					if (d.valeur > 20) { return y(20);}
					else { return y(d.valeur);}
				})
				.attr("transform", function(d){
					if (d.valeur > 20) { return "translate(0," + y(d.valeur - 20) + ")";}
				//	else if (d.valeur > 20) { return "translate(0," + y(d.valeur - 20) + ")";}
					else { return "translate(0,0)";}
				})
				.attr("fill", function(d,i) {
					if (i === 1) { return "rgba(106,237,117,1)";}
					else { return "rgba(106,237,117,0.5)";}
				});

			bar.append("text")
				.attr("x", barWidth / 2)
				.attr("y", -5)
				.attr("dx", ".50em")
				.style("fill",function(d){
					if (d.valeur <= 20) { return "rgb(106,237,117)";}
					else if ( d.valeur <= 50) { return "rgb(75,161,216)";}
					else if ( d.valeur <= 60) { return "rgb(121,146,155)";}
					else { return "rgb(160,8,69)";}
				})
				.text(function(d) {return d.valeur.substring(0,2);})

		})
		</script>
		<script>

		// function Get(url) {
		// 	var request = new XMLHttpRequest();
		// 	request.open('GET', url, false);
		// 	request.send(null);
		// 	return request.responseText;
		// }
		//
		// function GetData(JSONresponse) {
		// 	return JSONresponse.indices.data;
		// }

		var requestUrlGrenoble = 'https://api.atmo-aura.fr/communes/38185/indices?api_token=5a6f7194e07ab6051fe96ccf49a30bdf';
	//	var grenobleData = GetData(JSON.parse(Get(requestUrlGrenoble)));

		var requestUrlLyon = 'https://api.atmo-aura.fr/communes/69381/indices?api_token=5a6f7194e07ab6051fe96ccf49a30bdf';
	//	var lyonData = GetData(JSON.parse(Get(requestUrlLyon)));

		var requestUrlValence = 'https://api.atmo-aura.fr/communes/26362/indices?api_token=5a6f7194e07ab6051fe96ccf49a30bdf';
	//	var valenceData = GetData(JSON.parse(Get(requestUrlValence)));

		var width = 1000;
		var height = 1000;
		var widthScale = d3.scaleLinear()
											.domain([0,100])
											.range([0,height/3]);

		var canvas = d3.select("p").append("svg")
										.attr("width",width)
										.attr("height",height)
										.append("g");

		d3.json(requestUrlValence, function(data) {
			console.log(data["indices"]["data"]);
			var rectYBase = 700;
			canvas.selectAll("rect.valenceData")
					.classed("valenceData", true)
					.data(data["indices"]["data"])
					.enter()
						.filter(function(d, i) {return i < 8;})
						.append('rect')
						.attr('width', function(d, i) {return d.valeur;})
						.attr('height', function(d, i) {return d.valeur;})
						.attr("x", function(d) {return (50 - d.valeur/2);})
						.attr("y", function(d, i) {
								rectYBase = rectYBase - d.valeur;
								return rectYBase;
						})
						.attr('fill', function(d) {
							var g = 250 - d.valeur * 3;
							var r = d.valeur * 3;
							return "rgb("+r+","+g+",64)"});
		})

		d3.json(requestUrlGrenoble, function(data) {
			console.log(data["indices"]["data"]);
			var rectYBase = 700;
			var rectXBase = 100;
			canvas.selectAll("rect.grenobleData")
					.classed("grenobleData", true)
					.data(data["indices"]["data"])
					.enter()
						.filter(function(d, i) {return i < 8;})
						.append('rect')
						.attr('width', function(d, i) {return d.valeur;})
						.attr('height', function(d, i) {return d.valeur;})
						.attr('x', function(d) {return (rectXBase + 50 - d.valeur/2);})
						.attr("y", function(d) {
								rectYBase = rectYBase - d.valeur;
								return rectYBase;
						})
						.attr('fill', function(d) {
							var g = 250 - d.valeur * 3;
							var r = d.valeur * 3;
							return "rgb("+r+","+g+",64)"});
		})

		d3.json(requestUrlLyon, function(data) {
			console.log(data["indices"]["data"]);
			var rectYBase = 700;
			var rectXBase = 200;
			canvas.selectAll("rect.lyonData")
					.classed("lyonData", true)
					.attr('class', 'lyonData')
					.data(data["indices"]["data"])
					.enter()
						.filter(function(d, i) {return i < 8;})
						.append('rect')
						.attr('width', function(d, i) {return d.valeur;})
						.attr('height', function(d, i) {return d.valeur;})
						.attr('x', function(d) {return (rectXBase + 50 - d.valeur/2);})
						.attr("y", function(d) {
								rectYBase = rectYBase - d.valeur;
								return rectYBase;
						})
						.attr('fill', function(d) {
							var g = 250 - d.valeur * 3;
							var r = d.valeur * 3;
							return "rgb("+r+","+g+",64)"})
						.on("mouseover", function(d,i){
							console.log(d,i, canvas, this, this.ownerSVGElement);
							canvas.append("text")
								.attr({
								id : "t",
								x : 300,
								y : 300}).text(function() {return d.date + " : " + d.valeur;});;

						});

						//
						function handleMouseOver() {
							console.log("hover");
							this.append("text")
								.attr({
								id : "t",
								x : 300,
								y : 300
							})
								.text(function() {return d + " : " + i;});
						}

		})

		canvas.append("line")
					.attr("x1",10)
					.attr("y1",700)
					.attr("x2",500)
					.attr("y2",700)
					.attr("stroke","black");



		</script>

</body>
</html>
